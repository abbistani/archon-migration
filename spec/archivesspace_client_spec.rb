require_relative 'spec_helper'

describe "ResponseReader" do

  before(:all) do
    @rr = ArchivesSpace::ResponseReader.new
  end

  it "can managed fragmentary messages coming from ASpace" do

    # ripped straight from the headlines
    message_stream = [
                      "{\"status\":[{\"id\":1,\"label\":\"Reading JSON records\",\"type\":\"started\"},{\"id\":1,\"label\":\"Reading JSON records\",\"type\":\"done\"},{\"id\":2,\"label\":\"Validating records and checking links\",\"type\":\"started\"},{\"id\":2,\"label\":\"Validating records and checking links\",\"type\":\"done\"},{\"id\":3,\"label\":\"Evaluating record relationships\",\"type\":\"started\"},{\"id\":3,\"label\":\"Evaluating record relationships\",\"type\":\"done\"},{\"id\":4,\"label\":\"Saving records: cycle 1\",\"type\":\"started\"},{\"id\":4,\"label\":\"Saving records: cycle 1\",\"type\":\"done\"},{\"id\":5,\"label\":\"Dealing with circular dependencies: cycle 1\",\"type\":\"started\"},{\"id\":5,\"label\":\"Dealing with circular dependencies: cycle 1\",\"type\":\"done\"},{\"id\":6,\"label\":\"Saving records: cycle 2\",\"type\":\"started\"},{\"id\":6,\"label\":\"Saving records: cycle 2\",\"type\":\"done\"},{\"id\":7,\"label\":\"Dealing with circular dependencies: cycle 2\",\"type\":\"started\"},{\"id\":7,\"label\":\"Dealing with circular dependencies: cycle 2\",\"type\":\"done\"},{\"id\":8,\"label\":\"Saving records: cycle 3\",\"type\":\"started\"},{\"id\":8,\"label\":\"Saving records: cycle 3\",\"type\":\"done\"},{\"id\":9,\"label\":\"Dealing with circular dependencies: cycle 3\",\"type\":\"started\"},{\"id\":9,\"label\":\"Dealing with circular dependencies: cycle 3\",\"type\":\"done\"},{\"id\":10,\"label\":\"Saving records: cycle 4\",\"type\":\"started\"},{\"id\":10,\"label\":\"Saving records: cycle 4\",\"type\":\"done\"},{\"id\":11,\"label\":\"Dealing with circular dependencies: cycle 4\",\"type\":\"started\"},{\"id\":11,\"label\":\"Dealing with circular dependencies: cycle 4\",\"type\":\"done\"},{\"id\":12,\"label\":\"Saving records: cycle 5\",\"type\":\"started\"},{\"id\":12,\"label\":\"Saving records: cycle 5\",\"type\":\"done\"},{\"id\":13,\"label\":\"Dealing with circular dependencies: cycle 5\",\"type\":\"started\"},{\"id\":13,\"label\":\"Dealing with circular dependencies: cycle 5\",\"type\":\"done\"},{\"id\":14,\"label\":\"Saving records: cycle 6\",\"type\":\"started\"},{\"id\":14,\"label\":\"Saving records: cycle 6\",\"type\":\"done\"},{\"id\":15,\"label\":\"Dealing with circular dependencies: cycle 6\",\"type\":\"started\"},{\"id\":15,\"label\":\"Dealing with circular dependencies: cycle 6\",\"type\":\"done\"},{\"id\":16,\"label\":\"Saving records: cycle 7\",\"type\":\"started\"},{\"id\":16,\"label\":\"Saving records: cycle 7\",\"type\":\"done\"},{\"id\":17,\"label\":\"Dealing with circular dependencies: cycle 7\",\"type\":\"started\"},{\"id\":17,\"label\":\"Dealing with circular dependencies: cycle 7\",\"type\":\"done\"},{\"id\":18,\"label\":\"Saving records: cycle 8\",\"type\":\"started\"},{\"id\":18,\"label\":\"Saving records: cycle 8\",\"type\":\"done\"},{\"id\":19,\"label\":\"Dealing with circular dependencies: cycle 8\",\"type\":\"started\"},{\"id\":19,\"label\":\"Dealing with circular dependencies: cycle 8\",\"type\":\"done\"},{\"id\":20,\"label\":\"Saving records: cycle 9\",\"type\":\"started\"},{\"id\":20,\"label\":\"Saving records: cycle 9\",\"type\":\"done\"},{\"id\":21,\"label\":\"Dealing with circular dependencies: cycle 9\",\"type\":\"started\"},{\"id\":21,\"label\":\"Dealing with circular dependencies: cycle 9\",\"type\":\"done\"},{\"id\":22,\"label\":\"Saving records: cycle 10\",\"type\":\"started\"},{\"id\":22,\"label\":\"Saving records: cycle 10\",\"type\":\"done\"},{\"id\":23,\"label\":\"Dealing with circular dependencies: cycle 10\",\"type\":\"started\"},{\"id\":23,\"label\":\"Dealing with circular dependencies: cycle 10\",\"type\":\"done\"},{\"id\":24,\"label\":\"Saving records: cycle 11\",\"type\":\"started\"},{\"id\":24,\"label\":\"Saving records: cycle 11\",\"type\":\"done\"},{\"id\":25,\"label\":\"Dealing with circular dependencies: cycle 11\",\"type\":\"started\"},{\"id\":25,\"label\":\"Dealing with circular dependencies: cycle 11\",\"type\":\"done\"},{\"id\":26,\"label\":\"Saving records: cycle 12\",\"type\":\"started\"},{\"id\":26,\"label\":\"Saving records: cycle 12\",\"type\":\"done\"},{\"id\":27,\"label\":\"Dealing with circular dependencies: cycle 12\",\"type\":\"started\"},{\"id\":27,\"label\":\"Dealing with circular dependencies: cycle 12\",\"type\":\"done\"},{\"id\":28,\"label\":\"Saving records: cycle 13\",\"type\":\"started\"},{\"id\":28,\"label\":\"Saving records: cycle 13\",\"type\":\"done\"},{\"id\":29,\"label\":\"Dealing with circular dependencies: cycle 13\",\"type\":\"started\"},{\"id\":29,\"label\":\"Dealing with circular dependencies: cycle 13\",\"type\":\"done\"},{\"id\":30,\"label\":\"Saving records: cycle 14\",\"type\":\"started\"},{\"id\":30,\"label\":\"Saving records: cycle 14\",\"type\":\"done\"},{\"id\":31,\"label\":\"Dealing with circular dependencies: cycle 14\",\"type\":\"started\"},{\"id\":31,\"label\":\"Dealing with circular dependencies: cycle 14\",\"type\":\"done\"},{\"id\":32,\"label\":\"Saving records: cycle 15\",",
                      "\"type\":\"started\"},{\"id\":32,\"label\":\"Saving records: cycle 15\",\"type\":\"done\"},{\"id\":33,\"label\":\"Dealing with circular dependencies: cycle 15\",\"type\":\"started\"},{\"id\":33,\"label\":\"Dealing with circular dependencies: cycle 15\",\"type\":\"done\"},{\"id\":34,\"label\":\"Saving records: cycle 16\",\"type\":\"started\"},{\"id\":34,\"label\":\"Saving records: cycle 16\",\"type\":\"done\"},{\"id\":35,\"label\":\"Dealing with circular dependencies: cycle 16\",\"type\":\"started\"},{\"id\":35,\"label\":\"Dealing with circular dependencies: cycle 16\",\"type\":\"done\"},{\"id\":36,\"label\":\"Saving records: cycle 17\",\"type\":\"started\"},{\"id\":36,\"label\":\"Saving records: cycle 17\",\"type\":\"done\"},{\"id\":37,\"label\":\"Dealing with circular dependencies: cycle 17\",\"type\":\"started\"},{\"id\":37,\"label\":\"Dealing with circular dependencies: cycle 17\",\"type\":\"done\"},{\"id\":38,\"label\":\"Saving records: cycle 18\",\"type\":\"started\"},{\"id\":38,\"label\":\"Saving records: cycle 18\",\"type\":\"done\"},{\"id\":39,\"label\":\"Dealing with circular dependencies: cycle 18\",\"type\":\"started\"},{\"id\":39,\"label\":\"Dealing with circular dependencies: cycle 18\",\"type\":\"done\"},{\"id\":40,\"label\":\"Saving records: cycle 19\",\"type\":\"started\"},{\"id\":40,\"label\":\"Saving records: cycle 19\",\"type\":\"done\"},{\"id\":41,\"label\":\"Dealing with circular dependencies: cycle 19\",\"type\":\"started\"},{\"id\":41,\"label\":\"Dealing with circular dependencies: cycle 19\",\"type\":\"done\"},{\"id\":42,\"label\":\"Saving records: cycle 20\",\"type\":\"started\"},{\"id\":42,\"label\":\"Saving records: cycle 20\",\"type\":\"done\"},{\"id\":43,\"label\":\"Dealing with circular dependencies: cycle 20\",\"type\":\"started\"},{\"id\":43,\"label\":\"Dealing with circular dependencies: cycle 20\",\"type\":\"done\"},{\"id\":44,\"label\":\"Saving records: cycle 21\",\"type\":\"started\"},{\"id\":44,\"label\":\"Saving records: cycle 21\",\"type\":\"done\"},{\"id\":45,\"label\":\"Dealing with circular dependencies: cycle 21\",\"type\":\"started\"},{\"id\":45,\"label\":\"Dealing with circular dependencies: cycle 21\",\"type\":\"done\"},{\"id\":46,\"label\":\"Saving records: cycle 22\",\"type\":\"started\"},{\"id\":46,\"label\":\"Saving records: cycle 22\",\"type\":\"done\"},{\"id\":47,\"label\":\"Dealing with circular dependencies: cycle 22\",\"type\":\"started\"},{\"id\":47,\"label\":\"Dealing with circular dependencies: cycle 22\",\"type\":\"done\"},{\"id\":48,\"label\":\"Saving records: cycle 23\",\"type\":\"started\"},{\"id\":48,\"label\":\"Saving records: cycle 23\",\"type\":\"done\"},{\"id\":49,\"label\":\"Dealing with circular dependencies: cycle 23\",\"type\":\"started\"},{\"id\":49,\"label\":\"Dealing with circular dependencies: cycle 23\",\"type\":\"done\"},{\"id\":50,\"label\":\"Saving records: cycle 24\",\"type\":\"started\"},{\"id\":50,\"label\":\"Saving records: cycle 24\",\"type\":\"done\"},{\"id\":51,\"label\":\"Dealing with circular dependencies: cycle 24\",\"type\":\"started\"},{\"id\":51,\"label\":\"Dealing with circular dependencies: cycle 24\",\"type\":\"done\"},{\"id\":52,\"label\":\"Saving records: cycle 25\",\"type\":\"started\"},{\"id\":52,\"label\":\"Saving records: cycle 25\",\"type\":\"done\"},{\"id\":53,\"label\":\"Cleaning up\",\"type\":\"started\"},{\"id\":53,\"label\":\"Cleaning up\",\"type\":\"done\"}]},\n",
                      "{\"saved\":{\"/repositories/2/digital_objects/import_-4002584007866701510-4262\":[\"/repositories/2/digital_objects/596\",596],\"/repositories/2/digital_objects/import_-4002584007866701510-4261\":[\"/repositories/2/digital_objects/597\",597],\"/repositories/2/digital_object_components/import_-1670716676874793766-4266\":[\"/repositories/2/digital_object_components/567\",567],\"/repositories/2/digital_object_components/import_-1670716676874793766-4267\":[\"/repositories/2/digital_object_components/565\",565],\"/repositories/2/digital_object_components/import_-1670716676874793766-4268\":[\"/repositories/2/digital_object_components/563\",563],\"/repositories/2/digital_object_components/import_-1670716676874793766-4269\":[\"/repositories/2/digital_object_components/561\",561],\"/repositories/2/digital_object_components/import_-1670716676874793766-4282\":[\"/repositories/2/digital_object_components/589\",589],\"/repositories/2/digital_object_components/import_-1670716676874793766-4283\":[\"/repositories/2/digital_object_components/588\",588],\"/repositories/2/digital_object_components/import_-1670716676874793766-4284\":[\"/repositories/2/digital_object_components/587\",587],\"/repositories/2/digital_object_components/import_-1670716676874793766-4285\":[\"/repositories/2/digital_object_components/586\",586],\"/repositories/2/digital_object_components/import_-1670716676874793766-4286\":[\"/repositories/2/digital_object_components/585\",585],\"/repositories/2/digital_object_components/import_-1670716676874793766-4287\":[\"/repositories/2/digital_object_components/584\",584],\"/repositories/2/digital_object_components/import_-1670716676874793766-4288\":[\"/repositories/2/digital_object_components/583\",583],\"/repositories/2/digital_object_components/import_-1670716676874793766-4289\":[\"/repositories/2/digital_object_components/582\",582],\"/repositories/2/digital_object_components/import_-1670716676874793766-4290\":[\"/repositories/2/digital_object_components/581\",581],\"/repositories/2/digital_object_components/import_-1670716676874793766-4291\":[\"/repositories/2/digital_object_components/580\",580],\"/repositories/2/digital_object_components/import_-1670716676874793766-4292\":[\"/repositories/2/digital_object_components/579\",579],\"/repositories/2/digital_object_components/import_-1670716676874793766-4293\":[\"/repositories/2/digital_object_components/578\",578],\"/repositories/2/digital_object_components/import_-1670716676874793766-4294\":[\"/repositories/2/digital_object_components/577\",577],\"/repositories/2/digital_object_components/import_-1670716676874793766-4295\":[\"/repositories/2/digital_object_components/576\",576],\"/repositories/2/digital_object_components/import_-1670716676874793766-4296\":[\"/repositories/2/digital_object_components/575\",575],\"/repositories/2/digital_object_components/import_-1670716676874793766-4297\":[\"/repositories/2/digital_object_components/574\",574],\"/repositories/2/digital_object_components/import_-1670716676874793766-4298\":[\"/repositories/2/digital_object_components/573\",573],\"/repositories/2/digital_object_components/import_-1670716676874793766-4299\":[\"/repositories/2/digital_object_components/572\",572],\"/repositories/2/digital_object_components/import_-1670716676874793766-4300\":[\"/repositories/2/digital_object_components/571\",571],\"/repositories/2/digital_object_components/import_-1670716676874793766-4301\":[\"/repositories/2/digital_object_components/570\",570],\"/repositories/2/digital_object_components/import_-1670716676874793766-4302\":[\"/repositories/2/digital_object_components/569\",569],\"/repositories/2/digital_object_components/import_-1670716676874793766-4303\":[\"/repositories/2/digital_object_components/568\",568],\"/repositories/2/digital_object_components/import_-1670716676874793766-4304\":[\"/repositories/2/digital_object_components/566\",566],\"/repositories/2/digital_object_components/import_-1670716676874793766-4305\":[\"/repositories/2/digital_object_components/564\",564],\"/repositories/2/digital_object_components/import_-1670716676874793766-4306\":[\"/repositories/2/digital_object_components/562\",562]}}\n",
                      "\n]"
                     ]

    message_stream.each do |chunk|
      @rr.read(chunk) do |data|
        # all the data should be a hash, naturally
        data.should be_a(Hash)
      end
    end

    message_stream.each do |chunk|
      @rr.read(chunk) do |data|
        # if we yielded something, the @fragements cache should be empty
        @rr.instance_variable_get(:@fragments).should be_empty
      end
    end
  end
end

